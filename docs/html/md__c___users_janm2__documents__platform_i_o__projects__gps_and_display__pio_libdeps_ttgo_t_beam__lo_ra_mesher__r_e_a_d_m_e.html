<!-- HTML header for doxygen 1.9.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.9.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LoRa Mesher Library: LoRaMesher</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" /> <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
    </script>
</head>
<body>
        <div id="top">
            <!-- do not remove this div, it is closed by doxygen! -->
            <div id="titlearea">
                <table cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr id="projectrow">
                            <td id="projectalign">
                                <div id="projectname">LoRa Mesher Library
                                    <span id="projectnumber">&#160;0.0.4</span>
                                </div>
                                <div id="projectbrief">A LoRa Mesh library for the IoT</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- end header part --><!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__c___users_janm2__documents__platform_i_o__projects__gps_and_display__pio_libdeps_ttgo_t_beam__lo_ra_mesher__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">LoRaMesher </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Introduction</h1>
<p >The LoRaMesher library implements a distance-vector routing protocol for communicating messages among LoRa nodes. For the interaction with the LoRa radio chip, we leverage RadioLib, a versatile communication library which supports the SX127X LoRa series module available on the hardware we used, among others.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Dependencies</h1>
<p >You can check <code>library.json</code> for more details. Basically, we use a modded version of <a href="https://github.com/jgromes/RadioLib">Radiolib</a> that supports class methods as callbacks and <a href="https://freertos.org/index.html">FreeRTOS</a> for scheduling maintenance tasks.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Configure LoRaMesher with PlatformIO and Visual Studio Code</h1>
<ol type="1">
<li>Download Visual Studio Code.</li>
<li>Download PlatformIO inside Visual Studio Code.</li>
<li>Clone the <a class="el" href="class_lora_mesher.html">LoraMesher</a> repository.</li>
<li>Go to PlatformIO Home, click on the Projects button, then on "Add Existing", and find the examples/beta-sample source in the files.</li>
<li>Select the examples/beta-example project.</li>
<li>Build the project with PlatformIO.</li>
<li>Upload the project to the specified LoRa microcontroller. In our case, we use the TTGO T-Beam module.</li>
</ol>
<h1><a class="anchor" id="autotoc_md4"></a>
LoRaMesher Example</h1>
<p >There is, in the source files of this first implementation, an example to test the new functionalities. This example is an implementation of a counter, sending a broadcast message every 10 seconds. To make it easier to understand, we will remove additional functions that are not necessary to make the microcontroller work with the LoRaMesher library.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Defining the data type and the data counter</h2>
<p >As a proof of concept, we will be sending a numeric counter over LoRa. Its value will be incremented every 10 seconds, then te packet will be transmitted. To start, we need to implement the type of data we will use.</p>
<p >In this case, we will only send a <code>uint32_t</code>, which is the counter itself.</p>
<div class="fragment"><div class="line">uint32_t dataCounter = 0;</div>
<div class="line">struct dataPacket {</div>
<div class="line">  uint32_t counter = 0;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">dataPacket* helloPacket = new dataPacket;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
LoRaMesh Initialization</h2>
<p >To initialize the new implementation, LoRaMesher must be initialized with a function call. This function will be notified every time the microcontroller receives an incoming packet for the user.</p>
<div class="fragment"><div class="line">Serial.begin(115200); //This configuration can be changed</div>
<div class="line">Serial.println(&quot;initBoard&quot;);</div>
<div class="line"> </div>
<div class="line">//Get the LoraMesher instance</div>
<div class="line">LoraMesher&amp; radio = LoraMesher::getInstance();</div>
<div class="line"> </div>
<div class="line">//Initialize the LoraMesher with a processReceivedPackets function</div>
<div class="line">radio.init(processReceivedPackets);</div>
</div><!-- fragment --><p >We can see that, when starting a new instance of LoRaMesher, we need to pass through a function.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Received packets function</h2>
<p >The function that gets a notification each time the library receives a packet for the user looks like this one:</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * @brief Function that process the received packets</div>
<div class="line"> *</div>
<div class="line"> */</div>
<div class="line">void processReceivedPackets(void*) {</div>
<div class="line">  for (;;) {</div>
<div class="line">    /* Wait for the notification of processReceivedPackets and enter blocking */</div>
<div class="line">    ulTaskNotifyTake(pdPASS, portMAX_DELAY);</div>
<div class="line"> </div>
<div class="line">    //Iterate through all the packets inside the Received User Packets FiFo</div>
<div class="line">    while (radio.ReceivedUserPackets-&gt;Size() &gt; 0) {</div>
<div class="line">      //Get the first element inside the Received User Packets FiFo</div>
<div class="line">      LoraMesher::packetQueue&lt;dataPacket&gt;* helloReceived = radio.ReceivedUserPackets-&gt;Pop&lt;dataPacket&gt;();</div>
<div class="line"> </div>
<div class="line">      //Print the data packet</div>
<div class="line">      printDataPacket(helloReceived-&gt;packet);</div>
<div class="line"> </div>
<div class="line">      //Delete the packet when used. It is very important to delete the packets.</div>
<div class="line">      radio.deletepacketQueue(helloReceived);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p >There are some important things we need to be aware of:</p>
<ol type="1">
<li>This function should have a <code>void*</code> in the parameters.</li>
<li>The function should contain an endless loop.</li>
<li>Inside the loop, it is mandatory to have the <code>ulTaskNotifyTake(pdPASS,portMAX_DELAY)</code> or equivalent. This function allows the library to notify the function to process pending packets.</li>
<li>All the packets are stored inside <code>radio.ReceiveduserPackets</code>.</li>
<li>IMPORTANT!!! Every time you call Pop, you need to be sure to call deletepacketQueue. It will free the memory that has been allocated for the packet and the packetQueue. If not executed it can cause memory leaks and out of memory errors.</li>
</ol>
<h2><a class="anchor" id="autotoc_md8"></a>
Send data packet function</h2>
<p >In this section we will present how you can create and send packets. in this example we will use the <code>dataPacket</code> data structure.</p>
<div class="fragment"><div class="line">void loop() {</div>
<div class="line">      helloPacket-&gt;counter = dataCounter++;</div>
<div class="line"> </div>
<div class="line">      //Create packet and send it.</div>
<div class="line">       radio.createPacketAndSend(BROADCAST_ADDR, helloPacket, 1);</div>
<div class="line"> </div>
<div class="line">      //Wait 10 seconds to send the next packet</div>
<div class="line">      vTaskDelay(10000 / portTICK_PERIOD_MS);</div>
<div class="line">}</div>
</div><!-- fragment --><p >In the previous figure we can see that we are using the helloPacket, we add the counter inside it, and we create and send the packet using the LoRaMesher.</p>
<p >The most important part of this piece of code is the function that we call in the <code>radio.createPacketAndSend()</code>:</p>
<ol type="1">
<li>The first parameter is the destination, in this case the broadcast address.</li>
<li>And finally, the helloPacket (the packet we created) and the number of elements we are sending, in this case only 1 dataPacket.</li>
</ol>
<h2><a class="anchor" id="autotoc_md9"></a>
Print packet example</h2>
<p >When receiving the packet, we need to understand what the Queue will return us. For this reason, in the next subsection, we will explain how to implement a simple packet processing.</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * @brief Print the counter of the packet</div>
<div class="line"> *</div>
<div class="line"> * @param data</div>
<div class="line"> */</div>
<div class="line">void printPacket(dataPacket* data) {</div>
<div class="line">  Log.verbose(F(&quot;Hello Counter received n %X&quot; CR), data-&gt;counter);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">/**</div>
<div class="line"> * @brief Iterate through the payload of the packet and print the counter of the packet</div>
<div class="line"> *</div>
<div class="line"> * @param packet</div>
<div class="line"> */</div>
<div class="line">void printDataPacket(LoraMesher::packet&lt;dataPacket&gt;* packet) {</div>
<div class="line">  //Get the payload to iterate through it</div>
<div class="line">  dataPacket* packets = radio.getPayload(packet);</div>
<div class="line"> </div>
<div class="line">  for (size_t i = 0; i &lt; radio.getPayloadLength(packet); i++) {</div>
<div class="line">    //Print the packet</div>
<div class="line">    printPacket(&amp;packets[i]);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>After receiving the packet in the <code>processReceivedPackets()</code> function, we call the <code>printDataPacket()</code> function.</li>
<li>We need to get the payload of the packet, as we have different types of packet. The payload is not always in the same memory position. We have the function <code>radio.getPayload(packet)</code> that will return a pointer to the payload.</li>
<li>We iterate through the <code>radio.getPayloadLength(packet)</code>. This will let us know how big the payload is, in dataPackets types, for a given packet. In our case, we always send only one dataPacket.</li>
<li>Get the payload and call the <code>printPacket()</code> function, that will print the counter received. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
